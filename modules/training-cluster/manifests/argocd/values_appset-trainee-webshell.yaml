applicationsets:
- name: trainee-webshell
  namespace: argocd
  generators:
  - list:
      elements:
      %{~ for i in range(count-students) ~}
      - trainee-name: ${studentname-prefix}${i+1}
        password: ${passwords[i].bcrypt_hash}
        %{ if user-vm-enabled }
        ipv4-address: ${ipv4-address[i]}
        ipv6-addrss: ${ipv6-address[i]}
        ssh-public-key: ${chomp(ssh-keys[i].public_key_openssh)}
        ssh-private-key: ${base64encode(ssh-keys[i].private_key_pem)}
        %{ endif }
      %{~ endfor ~}
  template:
    metadata:
      name: '{{trainee-name}}-webshell'
    spec:
      project: default
      source:
        chart: webshell
        repoURL: https://argoproj.github.io/argo-helm
        targetRevision: 0.3.3
        helm:
          releaseName: '{{trainee-name}}-webshell'
          values: |
            user: {{trainee-name}}
            password: {{password}}
            ingress:
              enabled: true
              className: haproxy
              annotations:
                nginx.ingress.kubernetes.io/auth-type: basic-auth
                nginx.ingress.kubernetes.io/auth-secret: basic-auth
              hosts:
              - host: {{trainee-name}}.${cluster_name}.${cluster_domain}
                paths:
                - path: /
                  pathType: ImplementationSpecific
              tls:
              - hosts:
                - {{trainee-name}}.${cluster_name}.${cluster_domain}
                secretName: acend-wildcard
            theia:
              persistence:
                enabled: ${tostring(theia-persistence-enabled)}
                storageclass: longhorn
            dind:
              persistence:
                enabled: ${tostring(dind-persistence-enabled)}
                storageclass: longhorn
                pvcsize: 10Gi
            podSecurityContext:
              fsGroup: 1001
            updateStrategy:
              type: Recreate
            rbac:
              create: ${tostring(rbac-enabled)}   
            %{ if user-vm-enabled }
            init:
              command:
              - sh
              - -c
              - echo Welcome to the acend theia ide > /home/project/welcome && echo Your VM IP is {{ipv4-address}} / {{ipv6-address}} >> /home/project/welcome && echo You can login to your training VM using ssh -i id_ecdsa {{trainee-name}}@{{ipv4-address}} or ssh -i id_ecdsa {{trainee-name}}@{{ipv6-address}}>> /home/project/welcome && echo {{ssh-private-key}} | base64 -d > /home/project/id_ecdsa && chown 1001:1001 /home/project/id_ecdsa && chmod 600 /home/project/id_ecdsa
            %{ else }
            init:
              command:
              - sh
              - -c
              - echo Welcome to the acend theia ide > /home/project/welcome
            %{ endif }    
      destination:
        server: https://kubernetes.default.svc
        namespace: {{trainee-name}}
      syncPolicy:
        automated:
          prune: true
          selfHeal: true